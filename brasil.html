<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Brasil ‚Äî Amostra Cient√≠fica</title>
  <link rel="stylesheet" href="./css/styles.css?v=20250103-012">
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="./index.html" class="back-link">&larr; Voltar</a>
      <h1>
        Brasil
        <button id="country-info-btn" class="country-info-btn" title="Informa√ß√µes do Pa√≠s">
          ‚ÑπÔ∏è Info
        </button>
      </h1>
      <small>Clique nos estados para ver mais informa√ß√µes</small>
    </header>

    <section class="card tools">
      <input
        type="search"
        id="search-br"
        placeholder="Buscar estado (ex: S√£o Paulo, Minas Gerais...)"
        aria-label="Buscar estado"
      />
      <div style="display: flex; gap: 8px;">
        <button id="zoom-in-br" class="btn secondary" title="Aumentar Zoom">üîç+</button>
        <button id="zoom-out-br" class="btn secondary" title="Diminuir Zoom">üîç-</button>
        <button id="zoom-reset-br" class="btn secondary" title="Resetar Zoom">‚Ü∫</button>
      </div>
    </section>

    <section class="card full">

      <div class="map-wrap">
        <div id="map-br" class="map-box center">
          <!-- Fallback de demonstra√ß√£o com 3 UFs; ser√° substitu√≠do automaticamente se existir /assets/br-map.svg -->
          <svg viewBox="0 0 1000 700" role="img" aria-label="Mapa do Brasil">
            <title>Mapa do Brasil</title>
            <g id="demo">
              <path id="br-SP" class="state" d="M600 520 l120 0 l0 80 l-120 0 z" />
              <path id="br-RJ" class="state" d="M730 550 l90 0 l0 50 l-90 0 z" />
              <path id="br-MG" class="state" d="M620 420 l180 0 l0 90 l-180 0 z" />
            </g>
          </svg>
        </div>
      </div>
    </section>

  </div>

  <script src="./js/data-br.js?v=20250103-006"></script>
  <script src="./js/app.js?v=20250103-012"></script>
  <script>
    // Verificar se os dados foram carregados
    console.log('üáßüá∑ Dados do Brasil carregados?', {
      brazilData: !!window.brazilData,
      BR_STATES: !!window.BR_STATES,
      totalEstados: Object.keys(window.brazilData || {}).length
    });
    
    (async () => {
      const box = document.getElementById('map-br');
      // tenta injetar o SVG real, se estiver presente
      const svg = await window._amostra.injectSVG('./assets/br-map.svg', box);
      const svgRoot = svg || box.querySelector('svg');
      
      // CORRE√á√ÉO: Encontrar estado sem ID e adicionar br-RN
      setTimeout(() => {
        // Garantir que o SVG tenha atributos corretos  
        if (svgRoot) {
          svgRoot.setAttribute('width', '100%');
          svgRoot.setAttribute('height', 'auto');
          // CR√çTICO: maxWidth none permite zoom crescer livremente - v2
          svgRoot.style.maxWidth = 'none';
          svgRoot.style.height = 'auto';
          
          // Preservar viewBox original se existir
          if (!svgRoot.hasAttribute('viewBox')) {
            const bbox = svgRoot.getBBox();
            svgRoot.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
          }
          svgRoot.setAttribute('preserveAspectRatio', 'xMinYMin meet');
          console.log('‚úì SVG configurado:', svgRoot.getAttribute('viewBox'));
        }
        
        const allGroups = svgRoot.querySelectorAll('g[id^="br-"]');
        const existingIds = Array.from(allGroups).map(g => g.id);
        console.log('Estados encontrados:', existingIds);
        
        const todosEstados = ['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];
        const faltando = todosEstados.filter(uf => !existingIds.includes(`br-${uf}`));
        
        console.log('Estados faltando:', faltando);
        
        if (faltando.includes('RN')) {
          const grupos = svgRoot.querySelectorAll('g');
          grupos.forEach(g => {
            if (!g.id.startsWith('br-')) {
              const paths = g.querySelectorAll('path');
              paths.forEach(p => {
                const fill = p.getAttribute('style')?.includes('#999999');
                if (fill && !g.id.startsWith('br-')) {
                  g.id = 'br-RN';
                  g.classList.add('state');
                  console.log('‚úì ID br-RN adicionado ao grupo cinza');
                }
              });
            }
          });
        }
        
        window._amostra.bindMapInteractions(svgRoot, window.brazilData || {}, 'br');
        window._amostra.addStateLabels(svgRoot, 'br');
        
        setTimeout(() => {
          const searchInput = document.getElementById('search-br');
          
          if (!window.brazilData) {
            console.error('‚ùå window.brazilData n√£o est√° definido!');
            console.log('Tentando scripts alternativos...');
          }
          
          const dataset = window.brazilData || window.BR_STATES || {};
          
          console.log('üîç Teste de busca Brasil:', {
            searchInput: !!searchInput,
            svgRoot: !!svgRoot,
            brazilDataExiste: !!window.brazilData,
            datasetExiste: !!dataset,
            totalEstados: Object.keys(dataset).length,
            primeiroEstado: Object.keys(dataset)[0]
          });
          
          if (!searchInput) {
            console.error('‚ùå Campo de busca n√£o encontrado!');
            return;
          }
          
          if (!svgRoot) {
            console.error('‚ùå SVG n√£o encontrado!');
            return;
          }
          
          if (Object.keys(dataset).length === 0) {
            console.error('‚ùå Dataset est√° vazio! Verifique se data-br.js foi carregado.');
            return;
          }
          
          window._amostra.bindSearch('#search-br', svgRoot, dataset, 'br');
          console.log('‚úì Busca vinculada para Brasil com', Object.keys(dataset).length, 'estados');
          
          window.testarBuscaBrasil = function(termo) {
            searchInput.value = termo;
            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
          };
          console.log('üí° Para testar, digite no console: testarBuscaBrasil("s√£o")');
        }, 500);
        
        console.log('‚úì Mapa do Brasil configurado completamente');
        
        const isMobile = window.innerWidth <= 768;
        let currentZoom = isMobile ? 0.6 : 0.9;
        const minZoom = 0.3;
        const maxZoom = 6;
        const zoomStep = 0.3;
        
        function applyZoom(zoom) {
          if (svgRoot) {
            const widthPercent = zoom * 100;
            svgRoot.style.width = `${widthPercent}%`;
            svgRoot.style.height = 'auto';
            svgRoot.style.transition = 'width 0.3s ease';
            svgRoot.style.transformOrigin = 'top left';
            svgRoot.style.transform = '';
          }
        }
        
        applyZoom(currentZoom);
        
        setTimeout(() => {
          console.log('‚úì Zoom inicial aplicado');
        }, 100);
        
        // Fun√ß√µes de zoom
        const zoomIn = () => {
          currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
          applyZoom(currentZoom);
        };
        
        const zoomOut = () => {
          currentZoom = Math.max(currentZoom - zoomStep, minZoom);
          applyZoom(currentZoom);
        };
        
        const zoomReset = () => {
          currentZoom = isMobile ? 0.6 : 0.9;
          applyZoom(currentZoom);
        };
        
        // Bot√£o Zoom In - TOUCH + CLICK
        const btnZoomIn = document.getElementById('zoom-in-br');
        btnZoomIn.addEventListener('click', zoomIn);
        btnZoomIn.addEventListener('touchend', (e) => {
          e.preventDefault();
          e.stopPropagation();
          zoomIn();
        }, { passive: false });
        
        // Bot√£o Zoom Out - TOUCH + CLICK
        const btnZoomOut = document.getElementById('zoom-out-br');
        btnZoomOut.addEventListener('click', zoomOut);
        btnZoomOut.addEventListener('touchend', (e) => {
          e.preventDefault();
          e.stopPropagation();
          zoomOut();
        }, { passive: false });
        
        // Bot√£o Reset - TOUCH + CLICK
        const btnReset = document.getElementById('zoom-reset-br');
        btnReset.addEventListener('click', zoomReset);
        btnReset.addEventListener('touchend', (e) => {
          e.preventDefault();
          e.stopPropagation();
          zoomReset();
        }, { passive: false });
        
        // ===== PINCH-TO-ZOOM =====
        let initialDistance = 0;
        let initialZoom = 1;
        let isPinching = false;
        
        const mapWrap = document.querySelector('.map-wrap');
        
        console.log('üéØ Configurando pinch-to-zoom...');
        
        mapWrap.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            isPinching = true;
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            initialDistance = Math.hypot(
              touch2.clientX - touch1.clientX,
              touch2.clientY - touch1.clientY
            );
            initialZoom = currentZoom;
            console.log('‚úÖ Pinch iniciado! Dist√¢ncia:', initialDistance.toFixed(0));
          }
        }, { passive: true });
        
        mapWrap.addEventListener('touchmove', (e) => {
          if (e.touches.length === 2 && isPinching) {
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            const distance = Math.hypot(
              touch2.clientX - touch1.clientX,
              touch2.clientY - touch1.clientY
            );
            
            const scale = distance / initialDistance;
            const newZoom = Math.max(minZoom, Math.min(maxZoom, initialZoom * scale));
            
            if (Math.abs(newZoom - currentZoom) > 0.02) {
              currentZoom = newZoom;
              applyZoom(currentZoom);
              console.log('üîç Zoom aplicado:', (currentZoom * 100).toFixed(0) + '%');
            }
          }
        }, { passive: true });
        
        mapWrap.addEventListener('touchend', (e) => {
          if (isPinching) {
            console.log('‚úÖ Pinch finalizado! Zoom final:', (currentZoom * 100).toFixed(0) + '%');
            isPinching = false;
          }
        }, { passive: true });
        
        console.log('‚úì Controles de zoom habilitados no Brasil');
      }, 150);
      
      // Bot√£o de informa√ß√µes do pa√≠s
      const countryInfoBtn = document.getElementById('country-info-btn');
      if (countryInfoBtn) {
        countryInfoBtn.addEventListener('click', () => {
          const html = `
            <div class="alfabetizacao-destaque">
              <div class="taxa-principal">93,0%</div>
              <div class="taxa-label">Taxa de Alfabetiza√ß√£o Nacional (15+)</div>
            </div>
            
            <div class="info-grid">
              <div class="info-item">
                <span class="info-icon">üë•</span>
                <span class="info-label">Popula√ß√£o</span>
                <span class="info-value">215 milh√µes</span>
              </div>
              <div class="info-item">
                <span class="info-icon">üí∞</span>
                <span class="info-label">Renda per capita</span>
                <span class="info-value">R$ 1.400</span>
              </div>
              <div class="info-item">
                <span class="info-icon">üìä</span>
                <span class="info-label">IDH (2021)</span>
                <span class="info-value">0,754 (Alto)</span>
              </div>
              <div class="info-item">
                <span class="info-icon">üìà</span>
                <span class="info-label">Evolu√ß√£o 2010-2022</span>
                <span class="info-value">+6,2 p.p.</span>
              </div>
            </div>
            
            <div class="comparativo-nacional">
              <div class="comparativo-label">Estados e DF</div>
              <div style="display: flex; gap: 20px; justify-content: center; margin-top: 10px;">
                <div style="text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;">27</div>
                  <div style="font-size: 0.9rem; color: #666;">Total</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;">DF 97,9%</div>
                  <div style="font-size: 0.9rem; color: #666;">Maior taxa</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold; color: #FF9800;">AL 84,2%</div>
                  <div style="font-size: 0.9rem; color: #666;">Menor taxa</div>
                </div>
              </div>
            </div>
          `;
          window._amostra.Modal.show('üáßüá∑ Vis√£o Geral do Brasil', html);
        });
      }
    })();
  </script>
</body>
</html>